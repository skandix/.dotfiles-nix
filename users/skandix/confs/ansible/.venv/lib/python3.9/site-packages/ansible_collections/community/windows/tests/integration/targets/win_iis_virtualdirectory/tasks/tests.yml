---
- name: test site exists, but stopped in case of duplicate web binding
  win_iis_website:
    name: "{{ test_site_name }}"
    state: stopped
    physical_path: 'C:\inetpub\wwwroot'

- name: test virtual directory is absent (baseline)
  win_iis_virtualdirectory:
    state: absent
    site: "{{ test_site_name }}"
    name: "{{ test_vdir_name }}"

- name: create test virtual directory
  win_iis_virtualdirectory:
    state: present
    site: "{{ test_site_name }}"
    name: "{{ test_vdir_name }}"
    physical_path: "{{ test_physical_path }}"
  register: result

- assert:
    that:
    - 'result.changed == true'
    - 'result.directory.PhysicalPath == test_physical_path'

- name: create test virtual directory (idempotent)
  win_iis_virtualdirectory:
    state: present
    site: "{{ test_site_name }}"
    name: "{{ test_vdir_name }}"
    physical_path: "{{ test_physical_path }}"
  register: result

- assert:
    that:
    - 'result.changed == false'
    - 'result.directory.PhysicalPath == test_physical_path'

- name: set test virtual directory credentials
  win_iis_virtualdirectory:
    state: present
    site: "{{ test_site_name }}"
    name: "{{ test_vdir_name }}"
    connect_as: specific_user
    username: "{{ test_user }}"
    password: "{{ test_password }}"
  register: result

- assert:
    that:
    - 'result.changed == true'
    - 'result.directory.PhysicalPath == test_physical_path'

- name: set test virtual directory credentials (idempotent)
  win_iis_virtualdirectory:
    state: present
    site: "{{ test_site_name }}"
    name: "{{ test_vdir_name }}"
    connect_as: specific_user
    username: "{{ test_user }}"
    password: "{{ test_password }}"
  register: result

- assert:
    that:
    - 'result.changed == false'
    - 'result.directory.PhysicalPath == test_physical_path'

- name: create test application temporary directory
  ansible.windows.win_tempfile:
    suffix: ".{{ test_app_name }}"
    state: directory
  register: test_app_tmp_dir

- name: create new test application
  win_iis_webapplication:
    name: "{{ test_app_name }}"
    site: "{{ test_site_name }}"
    physical_path: "{{ test_app_tmp_dir.path }}"
    state: present

- name: create virtual directory and use pass through authentication
  win_iis_virtualdirectory:
    state: present
    site: "{{ test_site_name }}"
    name: "{{ test_vdir_name }}"
    physical_path: "{{ test_physical_path }}"
    connect_as: pass_through
    application: "{{ test_app_name }}"
  register: result

- assert:
    that:
    - 'result.changed == true'
    - 'result.directory.PhysicalPath == test_physical_path'

- name: create virtual directory and use pass through authentication (idempotent)
  win_iis_virtualdirectory:
    state: present
    site: "{{ test_site_name }}"
    name: "{{ test_vdir_name }}"
    physical_path: "{{ test_physical_path }}"
    connect_as: pass_through
    application: "{{ test_app_name }}"
  register: result

- assert:
    that:
    - 'result.changed == false'
    - 'result.directory.PhysicalPath == test_physical_path'